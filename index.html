<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>壘球計分板</title>
    <style>
        /* 重置某些基礎樣式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* 確保基礎容器寬度正確 */
        .batting-order {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: hidden !important;
        }

        /* 增加選擇器特異性 */
        .batting-order .batter-row[style*="font-weight: bold"] {
            display: grid !important;
            grid-template-columns: 40px 60px 150px 120px 80px !important;
            gap: 10px !important;
            align-items: center !important;
            cursor: default !important;
            margin-bottom: 10px !important;
            background-color: #f5f5f5 !important;
            font-weight: bold !important;
            padding: 10px 5px !important;
        }

        .batting-order .batter-row-main {
            display: grid !important;
            grid-template-columns: 40px 60px 150px 120px 80px !important;
            gap: 10px !important;
            align-items: center !important;
        }

        @media screen and (max-width: 768px) {
            .batting-order .batter-row[style*="font-weight: bold"] {
                grid-template-columns: 20px 45px 120px 100px 50px !important;
                gap: 5px !important;
                padding: 8px 5px !important;
                font-size: 14px !important;
            }

            .batting-order .batter-row-main {
                grid-template-columns: 20px 45px 120px 100px 50px !important;
                gap: 5px !important;
            }
        }

        @media screen and (max-width: 480px) {
            .batting-order .batter-row[style*="font-weight: bold"] {
                grid-template-columns: 20px 40px 100px 80px 45px !important;
                gap: 3px !important;
                padding: 6px 3px !important;
                font-size: 12px !important;
            }

            .batting-order .batter-row-main {
                grid-template-columns: 20px 40px 100px 80px 45px !important;
                gap: 3px !important;
            }
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
        }
        
        .scoreboard {
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-score {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .team {
            text-align: center;
            flex: 1;
            padding: 10px;
        }

        .team-name {
            font-size: 24px;
            padding: 5px;
            margin-bottom: 10px;
            background: none;
            border: 1px solid #666;
            color: white;
            text-align: center;
            width: 150px;
        }

        .score-buttons {
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        .game-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            gap: 30px;
        }

        .count-section {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 24px;
        }

        .count-lights {
            display: flex;
            gap: 10px;
        }

        .count-light {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #333;
            border: 2px solid #444;
        }

        .count-light.active.red {
            background-color: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }

        .count-light.active.yellow {
            background-color: #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }

        .count-light.active.green {
            background-color: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        .outs-controls {
            display: flex;
            gap: 3px;
            margin-left: auto;
        }

        .outs-controls button {
            padding: 2px 6px;
            font-size: 12px;
            min-width: 24px;
        }

        .out-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #666;
            display: inline-block;
        }

        .out-circle.active {
            background-color: #ff4444;
        }

        .count-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .count-controls {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .count-controls button {
            padding: 5px 10px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .count-controls button:hover {
            background-color: #45a049;
        }

        .reset-count-button {
            margin-top: 6px;
            align-self: flex-start;
            font-size: 12px;
            padding: 2px 6px;
        }

        .bases-display {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 20px auto;
            transform: rotate(0deg);
        }

        .base-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #333;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .base-indicator:hover {
            transform: scale(1.1);
        }

        .base-indicator.occupied {
            background-color: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }

        /* 二壘位置 */
        .base-indicator:nth-child(2) {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* 三壘位置 */
        .base-indicator:nth-child(1) {
            bottom: 20px;
            left: 20px;
        }

        /* 一壘位置 */
        .base-indicator:nth-child(3) {
            bottom: 20px;
            right: 20px;
        }

        .batting-orders-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .batting-order {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            color: black;
            max-width: 100%;
            overflow-x: hidden;
        }

        .batter-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 5px;
            padding: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: move;
            color: black;
        }

        .batter-row-main {
            display: grid;
            grid-template-columns: 40px 60px 150px 120px 80px;
            gap: 10px;
            align-items: center;
        }

        .batter-row-today {
            margin-top: 5px;
            padding-left: 40px;
            color: #666;
            font-size: 14px;
        }

        .batter-row.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        .batter-row.drag-over {
            border: 2px dashed #4CAF50;
        }

        .batter-row.current {
            background-color: #e3ffe3;
        }

        .batter-number-input, .batter-name {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            box-sizing: border-box;
            font-size: 14px;
            color: black;
            background-color: white;
        }

        .batter-row select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            color: black;
            background-color: white;
        }

        .result-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .result-controls select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            color: black;
            background-color: white;
        }

        .result-controls button {
            white-space: nowrap;
        }

        #batting-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .history-entry {
            padding: 5px;
            border-bottom: 1px solid #ddd;
            color: black;
        }

        .batting-stats {
            margin-top: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: black;
            overflow-x: auto;
        }

        .stats-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 14px;
            color: black;
        }

        .stats-table th,
        .stats-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            color: black;
            background-color: white;
        }

        .stats-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .inning-display {
            text-align: center;
            margin: 20px 0;
            font-size: 36px;
            color: white;
            background-color: #222;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
        }

        .inning-display button {
            margin-left: 15px;
        }

        .scoreboard-display {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            color: white;
            overflow-x: auto;
        }

        .scoreboard-table {
            width: 100%;
            min-width: 800px; /* 確保表格有最小寬度 */
            border-collapse: collapse;
            margin-top: 10px;
        }

        .game-info-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 20px 0;
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
        }

        .bases-and-inning {
            display: flex;
            align-items: center;
            gap: 40px;
            margin: 20px 0;
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
        }

        .bases-display {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0;
            transform: rotate(0deg);
        }

        .inning-display {
            text-align: center;
            font-size: 36px;
            color: white;
            margin: 0;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .game-status {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .count-section {
                width: 100%;
                justify-content: flex-start;
                margin-bottom: 6px;
            }

            .count-controls {
                margin-left: auto;
            }

            .bases-and-inning {
                flex-direction: row;
                gap: 20px;
                padding: 15px;
            }

            .bases-display {
                width: 120px;
                height: 120px;
            }

            .base-indicator {
                width: 30px;
                height: 30px;
            }

            .inning-display {
                font-size: 24px;
                padding: 10px;
            }

            .scoreboard-table input {
                font-size: 16px;
                padding: 3px;
                width: 35px;
            }

            .scoreboard-table th,
            .scoreboard-table td {
                padding: 5px;
            }
        }

        @media (max-width: 480px) {
            .bases-and-inning {
                padding: 10px;
            }

            .bases-display {
                width: 100px;
                height: 100px;
            }

            .base-indicator {
                width: 25px;
                height: 25px;
            }

            .inning-display {
                font-size: 20px;
                padding: 8px;
            }

            .inning-display button {
                font-size: 14px;
                padding: 5px 10px;
            }
        }

        .scoreboard-table th,
        .scoreboard-table td {
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
            font-size: 20px;
        }

        .scoreboard-table th {
            background-color: #333;
        }

        .scoreboard-table tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        .scoreboard-table input {
            width: 40px;
            text-align: center;
            background-color: #333;
            border: 1px solid #444;
            color: white;
            font-size: 20px;
            padding: 5px;
        }

        .scoreboard-table input:focus {
            background-color: #444;
            outline: none;
            border-color: #666;
        }

        .scoreboard-table td:first-child {
            min-width: 100px;
        }

        .scoreboard-table td:first-child input {
            width: 100%;
        }

        .batter-row {
            font-size: 14px;
        }

        .current {
            font-size: 14px;
        }

        .opponent-info {
            text-align: center;
            margin: 20px 0;
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .opponent-controls {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-width: min-content;
        }

        .opponent-controls span {
            white-space: nowrap;
        }

        .opponent-controls select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
            color: black;
        }

        @media (max-width: 768px) {
            .opponent-controls {
                flex-wrap: nowrap;
                font-size: 14px;
            }
            
            .opponent-controls button {
                padding: 8px;
                white-space: nowrap;
            }
            
            .opponent-controls select {
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .opponent-info {
                padding: 10px;
            }
            
            .opponent-controls {
                gap: 5px;
            }
            
            .opponent-controls button {
                padding: 5px;
                font-size: 14px;
            }
        }

        .result-controls button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .inning-display::after {
            content: attr(data-status);
            display: block;
            font-size: 16px;
            color: #aaa;
            margin-top: 5px;
        }

        .batting-order-label {
            color: #aaa;
            font-size: 16px;
            margin-top: 5px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .batting-orders-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .batting-order {
                margin-bottom: 0;
            }

            .stats-table {
                font-size: 12px;
            }

            .stats-table th,
            .stats-table td {
                padding: 4px 2px;
            }

            .result-controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            .result-controls select {
                flex: 1;
                min-width: 150px;
            }

            .result-controls input {
                width: 60px;
            }

            .result-controls button {
                width: 100%;
                margin-top: 5px;
            }
        }

        @media (max-width: 480px) {
            .batting-orders-row {
                gap: 10px;
            }

            .batting-order {
                padding: 10px;
            }

            .stats-table {
                font-size: 11px;
            }

            .result-controls select {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="scoreboard">
        <div class="team-score">
            <div class="team">
                <input type="text" class="team-name" id="home-team-name" onchange="updateTeamName('home')">
                <div class="score" id="home-score">0</div>
                <div class="score-buttons">
                    <button onclick="updateScore('home', 1)">+1</button>
                    <button onclick="updateScore('home', -1)">-1</button>
                </div>
                <div class="batting-order-label" id="home-batting-order"></div>
            </div>
            <div class="team">
                <input type="text" class="team-name" id="away-team-name" onchange="updateTeamName('away')">
                <div class="score" id="away-score">0</div>
                <div class="score-buttons">
                    <button onclick="updateScore('away', 1)">+1</button>
                    <button onclick="updateScore('away', -1)">-1</button>
                </div>
                <div class="batting-order-label" id="away-batting-order"></div>
            </div>
        </div>

        <div class="game-status">
            <div class="count-section">
                <span>S</span>
                <div class="count-lights">
                    <div class="count-light yellow" id="strike1"></div>
                    <div class="count-light yellow" id="strike2"></div>
                </div>
                <div class="count-controls">
                    <button onclick="updateCount('strike', 1)">+</button>
                    <button onclick="updateCount('strike', -1)">-</button>
                </div>
            </div>
            <div class="count-section">
                <span>B</span>
                <div class="count-lights">
                    <div class="count-light green" id="ball1"></div>
                    <div class="count-light green" id="ball2"></div>
                    <div class="count-light green" id="ball3"></div>
                </div>
                <div class="count-controls">
                    <button onclick="updateCount('ball', 1)">+</button>
                    <button onclick="updateCount('ball', -1)">-</button>
                </div>
            </div>
            <div class="count-section">
                <span>O</span>
                <div class="count-lights">
                    <div class="count-light red" id="out1"></div>
                    <div class="count-light red" id="out2"></div>
                </div>
                <div class="count-controls">
                    <button onclick="handleOutsChange(1)">+</button>
                    <button onclick="handleOutsChange(-1)">-</button>
                </div>
            </div>
        </div>

        <div class="bases-and-inning">
            <div class="bases-display">
                <div class="base-indicator" id="third" onclick="toggleBase('third')"></div>
                <div class="base-indicator" id="second" onclick="toggleBase('second')"></div>
                <div class="base-indicator" id="first" onclick="toggleBase('first')"></div>
            </div>
            <div class="inning-display">
                <span id="inning">1</span>局
                <span id="top-bottom">上</span>
                <button onclick="changeInning()">切換局數</button>
            </div>
        </div>

        <div class="scoreboard-display">
            <h3>記分板</h3>
            <table class="scoreboard-table">
                <thead>
                    <tr>
                        <th>隊伍</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>R</th>
                        <th>H</th>
                        <th>E</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" id="home-team-name-display"></td>
                        <td><input type="number" id="home-1" value="0" min="0"></td>
                        <td><input type="number" id="home-2" value="0" min="0"></td>
                        <td><input type="number" id="home-3" value="0" min="0"></td>
                        <td><input type="number" id="home-4" value="0" min="0"></td>
                        <td><input type="number" id="home-5" value="0" min="0"></td>
                        <td><input type="number" id="home-6" value="0" min="0"></td>
                        <td><input type="number" id="home-7" value="0" min="0"></td>
                        <td><input type="number" id="home-total" value="0" min="0"></td>
                        <td><input type="number" id="home-hits" value="0" min="0"></td>
                        <td><input type="number" id="home-errors" value="0" min="0"></td>
                    </tr>
                    <tr>
                        <td><input type="text" id="away-team-name-display"></td>
                        <td><input type="number" id="away-1" value="0" min="0"></td>
                        <td><input type="number" id="away-2" value="0" min="0"></td>
                        <td><input type="number" id="away-3" value="0" min="0"></td>
                        <td><input type="number" id="away-4" value="0" min="0"></td>
                        <td><input type="number" id="away-5" value="0" min="0"></td>
                        <td><input type="number" id="away-6" value="0" min="0"></td>
                        <td><input type="number" id="away-7" value="0" min="0"></td>
                        <td><input type="number" id="away-total" value="0" min="0"></td>
                        <td><input type="number" id="away-hits" value="0" min="0"></td>
                        <td><input type="number" id="away-errors" value="0" min="0"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="batting-order-container">
            <div class="batting-orders-row">
                <div class="batting-order">
                    <div class="lineup-header">
                        <h3>我方打擊順序</h3>
                        <select class="player-count-select" onchange="updatePlayerCount(this.value)">
                            <option value="10">10人</option>
                            <option value="11">11人</option>
                        </select>
                    </div>
                    <div class="batter-row" style="font-weight: bold; cursor: default;">
                        <div>序</div>
                        <div>背號</div>
                        <div>選手名稱</div>
                        <div>守備位置</div>
                        <div>目前</div>
                    </div>
                    <div id="batting-order-list"></div>
                </div>

                <div class="batting-order">
                    <h3>打擊結果記錄</h3>
                    <div class="result-controls">
                        <select id="batter-result">
                            <option value="一安">一安</option>
                            <option value="二安">二安</option>
                            <option value="三安">三安</option>
                            <option value="全壘打">全壘打</option>
                            <option value="失誤上壘">失誤上壘</option>
                            <option value="野選上壘">野選上壘</option>
                            <option value="四壞保送">四壞保送</option>
                            <option value="故意四壞">故意四壞</option>
                            <option value="三振">三振</option>
                            <option value="滾地出局">滾地出局</option>
                            <option value="飛球出局">飛球出局</option>
                            <option value="雙殺">雙殺</option>
                        </select>
                        <label style="margin: 0 5px;">打點:</label>
                        <input type="number" id="rbi-input" min="0" max="4" value="0" style="width: 50px;">
                        <button onclick="recordBatterResult()">記錄</button>
                    </div>
                    <div id="batting-history"></div>
                    <div style="margin-top: 20px;">
                        <button onclick="showGameSummary()">顯示比賽統計</button>
                        <button onclick="exportToCSV()">匯出統計表</button>
                    </div>
                </div>
            </div>

            <div class="batting-stats">
                <h3>打擊統計表</h3>
                <div class="stats-table-container">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>選手</th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>6</th>
                                <th>7</th>
                                <th>打數</th>
                                <th>安打</th>
                                <th>全壘打</th>
                                <th>打點</th>
                                <th>打擊率</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const POSITIONS = [
            "P投手", "C捕手", "1B一壘手", "2B二壘手", "3B三壘手",
            "SS游擊手", "LF左外野", "CF中外野", "RF右外野", "SF自由手", "EP"
        ];

        let gameState = {
            homeScore: 0,
            awayScore: 0,
            outs: 0,
            strikes: 1,
            balls: 1,
            inning: 1,
            isTop: true,
            bases: {
                first: false,
                second: false,
                third: false
            },
            currentBatter: 1,
            homeTeamName: "先攻",
            awayTeamName: "後攻",
            isBattingFirst: null,
            playerCount: 10,
            homeBattingOrder: Array(11).fill().map(() => ({
                number: "",
                name: "",
                position: "",
                battingSide: "右打",
                atBats: 0,
                hits: 0,
                homeRuns: 0,
                rbis: 0,
                inningResults: Array(7).fill(""),
                todayResults: []
            })),
            awayBattingOrder: Array(11).fill().map(() => ({
                name: "",
                position: "",
                battingSide: "右打",
                atBats: 0,
                hits: 0,
                rbis: 0
            }))
        };

        function createPositionSelect() {
            let select = document.createElement('select');
            select.innerHTML = '<option value="">選擇位置</option>' +
                POSITIONS.map(pos => `<option value="${pos}">${pos}</option>`).join('');
            return select;
        }

        function updatePlayerCount(count) {
            gameState.playerCount = parseInt(count);
            initializeBattingOrder();
        }

        function updateOpponentBatter(change) {
            gameState.opponentBatter = ((gameState.opponentBatter + change - 1 + gameState.opponentPlayerCount) % gameState.opponentPlayerCount) + 1;
            document.getElementById('opponent-batter-number').textContent = gameState.opponentBatter;
        }

        function updateOpponentPlayerCount(count) {
            gameState.opponentPlayerCount = parseInt(count);
            if (gameState.opponentBatter > gameState.opponentPlayerCount) {
                gameState.opponentBatter = 1;
                document.getElementById('opponent-batter-number').textContent = '1';
            }
        }

        function initializeBattingOrder() {
            const battingOrderList = document.getElementById('batting-order-list');
            battingOrderList.innerHTML = '';
            
            const currentOrder = gameState.homeBattingOrder;
            
            for (let i = 0; i < gameState.playerCount; i++) {
                const row = document.createElement('div');
                row.className = `batter-row ${i + 1 === gameState.currentBatter ? 'current' : ''}`;
                row.draggable = true;
                row.dataset.index = i;
                
                // 生成今日打擊記錄的顯示文字
                const todayResultsText = currentOrder[i].todayResults.length > 0 
                    ? currentOrder[i].todayResults.join('/') 
                    : '';
                
                row.innerHTML = `
                    <div class="batter-row-main">
                        <div class="batter-number">${i + 1}</div>
                        <input type="text" class="batter-number-input" 
                               value="${currentOrder[i].number}"
                               onchange="updateBatterInfo(${i}, 'number', this.value)"
                               placeholder="背號">
                        <input type="text" class="batter-name" 
                               value="${currentOrder[i].name}"
                               onchange="updateBatterInfo(${i}, 'name', this.value)"
                               placeholder="${i + 1}號打者">
                        <select onchange="updateBatterInfo(${i}, 'position', this.value)">
                            <option value="">選擇位置</option>
                            ${POSITIONS.map(pos => 
                                `<option value="${pos}" ${currentOrder[i].position === pos ? 'selected' : ''}>${pos}</option>`
                            ).join('')}
                        </select>
                        <div>${i + 1 === gameState.currentBatter ? '打擊中' : ''}</div>
                    </div>
                    <div class="batter-row-today">
                        ${todayResultsText ? '今日：' + todayResultsText : ''}
                    </div>
                `;

                // 添加拖放事件監聽器
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                
                battingOrderList.appendChild(row);
            }
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            // 儲存拖曳的資料
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.batter-row').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this === draggedElement) return;

            const fromIndex = parseInt(draggedElement.dataset.index);
            const toIndex = parseInt(this.dataset.index);

            // 更新打序資料
            const temp = {...gameState.homeBattingOrder[fromIndex]};
            
            if (fromIndex < toIndex) {
                // 向下移動
                for (let i = fromIndex; i < toIndex; i++) {
                    gameState.homeBattingOrder[i] = {...gameState.homeBattingOrder[i + 1]};
                }
            } else {
                // 向上移動
                for (let i = fromIndex; i > toIndex; i--) {
                    gameState.homeBattingOrder[i] = {...gameState.homeBattingOrder[i - 1]};
                }
            }
            gameState.homeBattingOrder[toIndex] = temp;

            // 如果當前打者在移動範圍內，更新當前打者號碼
            if (gameState.currentBatter - 1 === fromIndex) {
                gameState.currentBatter = toIndex + 1;
            } else if (
                (gameState.currentBatter - 1 >= Math.min(fromIndex, toIndex)) && 
                (gameState.currentBatter - 1 <= Math.max(fromIndex, toIndex))
            ) {
                if (fromIndex < toIndex) {
                    gameState.currentBatter--;
                } else {
                    gameState.currentBatter++;
                }
            }

            // 重新渲染打序表
            initializeBattingOrder();
        }

        function updateBatterInfo(index, field, value) {
            gameState.homeBattingOrder[index][field] = value;
        }

        function updateTeamName(team) {
            const newName = document.getElementById(team + '-team-name').value;
            if (team === 'home') {
                gameState.homeTeamName = newName;
            } else {
                gameState.awayTeamName = newName;
            }
            updateScoreboard();
        }

        function updateScoreboard() {
            // 更新隊伍名稱
            document.getElementById('home-team-name-display').value = gameState.homeTeamName;
            document.getElementById('away-team-name-display').value = gameState.awayTeamName;
            
            // 更新總分
            document.getElementById('home-total').value = gameState.homeScore;
            document.getElementById('away-total').value = gameState.awayScore;
        }

        function updateScore(team, change) {
            const scoreElement = document.getElementById(team + '-score');
            const currentScore = parseInt(scoreElement.textContent);
            const newScore = Math.max(0, currentScore + change);
            scoreElement.textContent = newScore;
            if (team === 'home') {
                gameState.homeScore = newScore;
            } else {
                gameState.awayScore = newScore;
            }
        }

        function handleOutsChange(change) {
            const newOuts = gameState.outs + change;
            if (newOuts >= 0 && newOuts <= 2) {
                gameState.outs = newOuts;
                updateOutsDisplay();
                
                // 重置好壞球數為一好一壞
                gameState.strikes = 1;
                gameState.balls = 1;
                updateCountDisplay('strike', 1);
                updateCountDisplay('ball', 1);
                
                if (gameState.outs === 2) {
                    setTimeout(() => {
                        if (confirm('已三出局，是否要切換局數？')) {
                            changeInning();
                        }
                    }, 100);
                }
            }
        }

        function updateOutsDisplay() {
            for (let i = 1; i <= 2; i++) {
                const outLight = document.getElementById('out' + i);
                outLight.className = 'count-light red' + (i <= gameState.outs ? ' active' : '');
            }
            const outsControls = document.querySelector('.outs-controls');
            if (outsControls) {
                outsControls.style.display = gameState.isBattingFirst === gameState.isTop ? 'none' : 'flex';
            }
        }

        function toggleBase(base) {
            gameState.bases[base] = !gameState.bases[base];
            const baseElement = document.getElementById(base);
            baseElement.className = 'base-indicator' + (gameState.bases[base] ? ' occupied' : '');
        }

        function changeInning() {
            gameState.isTop = !gameState.isTop;
            if (gameState.isTop) {
                gameState.inning++;
            }
            document.getElementById('inning').textContent = gameState.inning;
            document.getElementById('top-bottom').textContent = gameState.isTop ? '上' : '下';
            
            // 重置出局數
            gameState.outs = 0;
            updateOutsDisplay();
            
            // 重置好壞球數為一好一壞
            gameState.strikes = 1;
            gameState.balls = 1;
            updateCountDisplay('strike', 1);
            updateCountDisplay('ball', 1);
            
            // 重置壘包狀態
            Object.keys(gameState.bases).forEach(base => {
                gameState.bases[base] = false;
                document.getElementById(base).className = 'base-indicator';
            });
            
            updateRecordButtonState();
            initializeBattingOrder();
        }

        function recordBatterResult() {
            const currentBatterInfo = gameState.homeBattingOrder[gameState.currentBatter - 1];
            const batterName = currentBatterInfo.name || `${gameState.currentBatter}號打者`;
            const batterNumber = currentBatterInfo.number ? `#${currentBatterInfo.number} ` : '';
            const batterResult = document.getElementById('batter-result').value;
            const rbis = parseInt(document.getElementById('rbi-input').value) || 0;

            // 添加今日打擊記錄
            currentBatterInfo.todayResults.push(batterResult);

            // 處理出局數
            let outsToAdd = 0;
            switch (batterResult) {
                case '三振':
                case '滾地出局':
                case '飛球出局':
                    outsToAdd = 1;
                    break;
                case '雙殺':
                    outsToAdd = 2;
                    break;
            }

            // 更新出局數
            if (outsToAdd > 0) {
                gameState.outs += outsToAdd;
                updateOutsDisplay();
            }

            // 更新打擊統計
            if (!['四壞保送', '故意四壞'].includes(batterResult)) {
                currentBatterInfo.atBats++;
            }
            if (['一安', '二安', '三安', '全壘打'].includes(batterResult)) {
                currentBatterInfo.hits++;
                if (batterResult === '全壘打') {
                    currentBatterInfo.homeRuns++;
                }
            }
            currentBatterInfo.rbis += rbis;

            // 記錄當局打擊結果
            const currentInning = gameState.inning - 1;
            if (currentInning < 7) {
                currentBatterInfo.inningResults[currentInning] = batterResult;
            }

            // 更新打擊歷史記錄
            const history = document.getElementById('batting-history');
            const record = document.createElement('div');
            record.className = 'history-entry';
            const inningText = `${gameState.inning}局${gameState.isTop ? '上' : '下'}`;
            const battingStats = `${currentBatterInfo.atBats}之${currentBatterInfo.hits}`;
            const rbiText = rbis > 0 ? ` 打點: ${rbis}` : '';
            record.textContent = `${inningText} - ${gameState.currentBatter}棒 ${batterNumber}${batterName} ${battingStats}: ${batterResult}${rbiText}`;
            history.insertBefore(record, history.firstChild);

            // 更新統計表格
            updateStatsTable();

            // 重置打點輸入
            document.getElementById('rbi-input').value = '0';

            // 更新下一棒
            gameState.currentBatter = gameState.currentBatter % gameState.playerCount + 1;

            // 檢查是否需要換局
            if (gameState.outs >= 3) {
                setTimeout(() => {
                    changeInning();
                }, 500);
            } else {
                initializeBattingOrder();
            }
        }

        function updateStatsTable() {
            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = '';

            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                const row = document.createElement('tr');
                
                // 選手名稱（包含背號）
                const playerName = player.number ? 
                    `#${player.number} ${player.name || `${i + 1}號打者`}` : 
                    (player.name || `${i + 1}號打者`);
                row.innerHTML = `<td>${playerName}</td>`;
                
                // 各局打擊結果
                for (let j = 0; j < 7; j++) {
                    row.innerHTML += `<td>${player.inningResults[j] || ''}</td>`;
                }
                
                // 打擊統計
                const avg = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000';
                row.innerHTML += `
                    <td>${player.atBats}</td>
                    <td>${player.hits}</td>
                    <td>${player.homeRuns}</td>
                    <td>${player.rbis}</td>
                    <td>${avg}</td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function showGameSummary() {
            let summary = `比賽統計\n`;
            summary += `${gameState.homeTeamName} ${gameState.homeScore} : ${gameState.awayScore} ${gameState.awayTeamName}\n\n`;
            summary += `打擊成績：\n`;
            
            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                if (player.atBats > 0) {
                    const avg = (player.hits / player.atBats).toFixed(3);
                    const playerName = player.name || `${i + 1}號打者`;
                    summary += `${playerName}: ${player.atBats}打數 ${player.hits}安打 打點: ${player.rbis} 打擊率${avg}\n`;
                }
            }

            alert(summary);
        }

        function updateCount(type, change) {
            const maxCount = type === 'strike' ? 2 : 3;
            if (type === 'strike') {
                gameState.strikes = Math.max(0, Math.min(maxCount, gameState.strikes + change));
                updateCountDisplay('strike', gameState.strikes);
            } else {
                gameState.balls = Math.max(0, Math.min(maxCount, gameState.balls + change));
                updateCountDisplay('ball', gameState.balls);
            }
        }

        function updateCountDisplay(type, count) {
            const maxCount = type === 'strike' ? 2 : 3;
            const lightClass = type === 'strike' ? 'yellow' : 'green';
            for (let i = 1; i <= maxCount; i++) {
                const light = document.getElementById(`${type}${i}`);
                light.className = `count-light ${lightClass}${i <= count ? ' active' : ''}`;
            }
        }

        function resetCount() {
            gameState.strikes = 1;
            gameState.balls = 1;
            updateCountDisplay('strike', gameState.strikes);
            updateCountDisplay('ball', gameState.balls);
        }

        // 新增：更新記錄按鈕狀態的函數
        function updateRecordButtonState() {
            const recordButton = document.querySelector('.result-controls button');
            const canRecord = gameState.isBattingFirst === gameState.isTop;
            recordButton.disabled = !canRecord;
            recordButton.style.opacity = canRecord ? '1' : '0.5';
            
            // 更新出局數控制按鈕的顯示
            updateOutsDisplay();
            
            // 更新提示文字
            const inningText = gameState.isTop ? '上' : '下';
            const battingStatus = canRecord ? '我方進攻' : '對方進攻';
            document.querySelector('.inning-display').setAttribute('data-status', 
                `${gameState.inning}局${inningText} - ${battingStatus}`);
        }

        function exportToCSV() {
            let csvContent = '\uFEFF';  // BOM for Excel UTF-8
            
            const homeTeamName = document.getElementById('home-team-name').value + 
                document.getElementById('home-batting-order').textContent;
            const awayTeamName = document.getElementById('away-team-name').value + 
                document.getElementById('away-batting-order').textContent;
            
            csvContent += `比賽結果：${homeTeamName} ${gameState.homeScore} : ${gameState.awayScore} ${awayTeamName}\n\n`;
            csvContent += '選手,打席,安打,打點,打擊率\n';
            
            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                if (player.atBats > 0) {
                    const avg = (player.hits / player.atBats).toFixed(3);
                    const playerName = player.name || `${i + 1}號打者`;
                    csvContent += `${playerName},${player.atBats},${player.hits},${player.rbis},${avg}\n`;
                }
            }

            csvContent += '\n詳細打擊紀錄\n';
            csvContent += '背號,選手,第1局,第2局,第3局,第4局,第5局,第6局,第7局,打數,安打,全壘打,打點,打擊率\n';

            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                const avg = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000';
                const playerName = player.name || `${i + 1}號打者`;
                
                let row = [
                    player.number,
                    playerName,
                    ...player.inningResults.slice(0, 7).map(result => result || ''),
                    player.atBats,
                    player.hits,
                    player.homeRuns,
                    player.rbis,
                    avg
                ];
                
                csvContent += row.map(field => {
                    if (field && field.toString().includes(',')) {
                        return `"${field}"`;
                    }
                    return field;
                }).join(',') + '\n';
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const filename = `比賽統計_${year}${month}${day}_${homeTeamName} vs ${awayTeamName}.csv`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(link.href);
        }

        // 初始化頁面
        function initializeGame() {
            const choice = confirm('請選擇您的隊伍順序：\n確定 = 先攻\n取消 = 後攻');
            gameState.isBattingFirst = choice;
            
            document.getElementById('home-batting-order').textContent = choice ? '（先攻）' : '（後攻）';
            document.getElementById('away-batting-order').textContent = choice ? '（後攻）' : '（先攻）';
            
            gameState.homeTeamName = document.getElementById('home-team-name').value;
            gameState.awayTeamName = document.getElementById('away-team-name').value;
            
            // 初始化好壞球數
            gameState.strikes = 1;
            gameState.balls = 1;
            
            updateScoreboard();
            updateRecordButtonState();
            initializeBattingOrder();
            updateCountDisplay('strike', 1);
            updateCountDisplay('ball', 1);
            updateStatsTable();

            // 為記分板輸入框添加事件監聽
            document.querySelectorAll('.scoreboard-table input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    // 確保數值不小於0
                    if (this.value < 0) this.value = 0;
                });
            });
        }

        // 初始化頁面
        window.onload = function() {
            initializeGame();
        };
    </script>
</body>
</html>