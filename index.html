<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>壘球計分板</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
        }
        
        .scoreboard {
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-score {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .team {
            text-align: center;
            flex: 1;
            padding: 10px;
        }

        .team-name {
            font-size: 24px;
            padding: 5px;
            margin-bottom: 10px;
            background: none;
            border: 1px solid #666;
            color: white;
            text-align: center;
            width: 150px;
        }

        .score-buttons {
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        .game-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
        }

        .outs-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .out-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #666;
            display: inline-block;
        }

        .out-circle.active {
            background-color: #ff4444;
        }

        .count-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .count-section {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .count-circle {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #666;
            display: inline-block;
        }

        .count-circle.active {
            background-color: #ff4444;
        }

        .count-controls {
            display: flex;
            gap: 5px;
        }

        .count-controls button {
            padding: 3px 8px;
            font-size: 12px;
        }

        .bases-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
        }

        .base-indicator {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .base-label {
            margin-right: 10px;
            font-weight: bold;
        }

        .base-status {
            width: 20px;
            height: 20px;
            background-color: white;
            border: 2px solid #666;
            cursor: pointer;
        }

        .base-status.occupied {
            background-color: #ff4444;
        }

        .batting-orders-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .batting-order {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            color: black;
        }

        .batter-row {
            display: grid;
            grid-template-columns: 25px 50px 150px 120px 60px;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: move;
            color: black;
        }

        .batter-row.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        .batter-row.drag-over {
            border: 2px dashed #4CAF50;
        }

        .batter-row.current {
            background-color: #e3ffe3;
        }

        .batter-number-input, .batter-name {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            box-sizing: border-box;
            font-size: 14px;
            color: black;
            background-color: white;
        }

        .batter-row select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            color: black;
            background-color: white;
        }

        .result-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .result-controls select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            color: black;
            background-color: white;
        }

        .result-controls button {
            white-space: nowrap;
        }

        #batting-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .history-entry {
            padding: 5px;
            border-bottom: 1px solid #ddd;
            color: black;
        }

        .batting-stats {
            margin-top: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: black;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: black;
        }

        .stats-table th,
        .stats-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            color: black;
            background-color: white;
        }

        .stats-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        .stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .inning-display {
            text-align: center;
            margin: 20px 0;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
        }

        .inning-display button {
            margin-left: 15px;
        }

        @media (max-width: 768px) {
            .scoreboard {
                padding: 15px;
            }

            .batting-orders-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .team-score {
                font-size: 20px;
            }

            .team-name {
                width: 120px;
                font-size: 20px;
            }

            .game-status {
                flex-direction: column;
                gap: 15px;
            }

            .bases-display {
                flex-wrap: wrap;
                justify-content: space-around;
            }

            .batter-row {
                grid-template-columns: 20px 45px 120px 100px 50px;
                gap: 5px;
                font-size: 14px;
            }

            .result-controls {
                flex-wrap: wrap;
            }

            .result-controls select,
            .result-controls input {
                min-height: 44px;
                font-size: 16px;
            }

            button {
                min-height: 44px;
                font-size: 16px;
            }

            .stats-table {
                font-size: 12px;
            }

            .inning-display {
                font-size: 18px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .batter-row {
                grid-template-columns: 20px 40px 100px 80px 45px;
                font-size: 12px;
            }

            .stats-table {
                font-size: 11px;
            }

            .stats-table th,
            .stats-table td {
                padding: 4px 2px;
            }

            .out-circle,
            .count-circle {
                width: 15px;
                height: 15px;
            }

            .base-status {
                width: 15px;
                height: 15px;
            }
        }

        .batter-row {
            font-size: 14px;
        }

        .current {
            font-size: 14px;
        }

        .opponent-info {
            text-align: center;
            margin: 20px 0;
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .opponent-controls {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-width: min-content;
        }

        .opponent-controls span {
            white-space: nowrap;
        }

        .opponent-controls select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
            color: black;
        }

        @media (max-width: 768px) {
            .opponent-controls {
                flex-wrap: nowrap;
                font-size: 14px;
            }
            
            .opponent-controls button {
                padding: 8px;
                white-space: nowrap;
            }
            
            .opponent-controls select {
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .opponent-info {
                padding: 10px;
            }
            
            .opponent-controls {
                gap: 5px;
            }
            
            .opponent-controls button {
                padding: 5px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="scoreboard">
        <div class="team-score">
            <div class="team">
                <input type="text" class="team-name" id="home-team-name" value="主隊" onchange="updateTeamName('home')">
                <div class="score" id="home-score">0</div>
                <div class="score-buttons">
                    <button onclick="updateScore('home', 1)">+1</button>
                    <button onclick="updateScore('home', -1)">-1</button>
                </div>
            </div>
            <div class="team">
                <input type="text" class="team-name" id="away-team-name" value="客隊" onchange="updateTeamName('away')">
                <div class="score" id="away-score">0</div>
                <div class="score-buttons">
                    <button onclick="updateScore('away', 1)">+1</button>
                    <button onclick="updateScore('away', -1)">-1</button>
                </div>
            </div>
        </div>

        <div class="inning-display">
            <span id="inning">1</span>局
            <span id="top-bottom">上</span>
            <button onclick="changeInning()">切換局數</button>
        </div>

        <div class="game-status">
            <div class="outs-display">
                出局數:
                <div class="out-circle" id="out1"></div>
                <div class="out-circle" id="out2"></div>
                <div class="out-circle" id="out3"></div>
                <button onclick="addOut()">增加出局</button>
                <button onclick="resetOuts()">重置出局</button>
            </div>
            <div class="count-display">
                <div class="count-section">
                    好球:
                    <div class="count-circle" id="strike1"></div>
                    <div class="count-circle" id="strike2"></div>
                    <div class="count-circle" id="strike3"></div>
                    <div class="count-controls">
                        <button onclick="updateCount('strike', 1)">+</button>
                        <button onclick="updateCount('strike', -1)">-</button>
                    </div>
                </div>
                <div class="count-section">
                    壞球:
                    <div class="count-circle" id="ball1"></div>
                    <div class="count-circle" id="ball2"></div>
                    <div class="count-circle" id="ball3"></div>
                    <div class="count-circle" id="ball4"></div>
                    <div class="count-controls">
                        <button onclick="updateCount('ball', 1)">+</button>
                        <button onclick="updateCount('ball', -1)">-</button>
                    </div>
                </div>
                <button onclick="resetCount()">重置球數</button>
            </div>
        </div>

        <div class="bases-display">
            <div class="section-title">壘包狀況:</div>
            <div class="base-indicator">
                <span class="base-label">一壘</span>
                <div class="base-status" id="first" onclick="toggleBase('first')"></div>
            </div>
            <div class="base-indicator">
                <span class="base-label">二壘</span>
                <div class="base-status" id="second" onclick="toggleBase('second')"></div>
            </div>
            <div class="base-indicator">
                <span class="base-label">三壘</span>
                <div class="base-status" id="third" onclick="toggleBase('third')"></div>
            </div>
        </div>

        <div class="opponent-info">
            <div class="opponent-controls">
                <span>對方打者: 第</span>
                <span id="opponent-batter-number">1</span>
                <span>棒</span>
                <button onclick="updateOpponentBatter(1)">下一棒</button>
                <button onclick="updateOpponentBatter(-1)">上一棒</button>
                <span class="small-label">人數:</span>
                <select id="opponent-player-count" onchange="updateOpponentPlayerCount(this.value)">
                    <option value="10">10人</option>
                    <option value="11">11人</option>
                </select>
            </div>
        </div>

        <div class="batting-order-container">
            <div class="batting-orders-row">
                <div class="batting-order">
                    <div class="lineup-header">
                        <h3>我方打擊順序</h3>
                        <select class="player-count-select" onchange="updatePlayerCount(this.value)">
                            <option value="10">10人</option>
                            <option value="11">11人</option>
                        </select>
                    </div>
                    <div class="batter-row" style="font-weight: bold; cursor: default;">
                        <div>序</div>
                        <div>背號</div>
                        <div>選手名稱</div>
                        <div>守備位置</div>
                        <div>目前</div>
                    </div>
                    <div id="batting-order-list"></div>
                </div>

                <div class="batting-order">
                    <h3>打擊結果記錄</h3>
                    <div class="result-controls">
                        <select id="batter-result">
                            <option value="一安">一安</option>
                            <option value="二安">二安</option>
                            <option value="三安">三安</option>
                            <option value="全壘打">全壘打</option>
                            <option value="失誤上壘">失誤上壘</option>
                            <option value="野選上壘">野選上壘</option>
                            <option value="四壞保送">四壞保送</option>
                            <option value="故意四壞">故意四壞</option>
                            <option value="三振">三振</option>
                            <option value="滾地出局">滾地出局</option>
                            <option value="飛球出局">飛球出局</option>
                            <option value="雙殺">雙殺</option>
                        </select>
                        <label style="margin: 0 5px;">打點:</label>
                        <input type="number" id="rbi-input" min="0" max="4" value="0" style="width: 50px;">
                        <button onclick="recordBatterResult()">記錄</button>
                    </div>
                    <div id="batting-history"></div>
                    <div style="margin-top: 20px;">
                        <button onclick="showGameSummary()">顯示比賽統計</button>
                        <button onclick="exportToCSV()">匯出統計表</button>
                    </div>
                </div>
            </div>

            <div class="batting-stats">
                <h3>打擊統計表</h3>
                <div class="stats-table-container">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>選手</th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>6</th>
                                <th>7</th>
                                <th>打數</th>
                                <th>安打</th>
                                <th>全壘打</th>
                                <th>打點</th>
                                <th>打擊率</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const POSITIONS = [
            "P投手", "C捕手", "1B一壘手", "2B二壘手", "3B三壘手",
            "SS游擊手", "LF左外野", "CF中外野", "RF右外野", "SF自由手", "EP"
        ];

        let gameState = {
            homeScore: 0,
            awayScore: 0,
            outs: 0,
            strikes: 1,
            balls: 1,
            inning: 1,
            isTop: true,
            bases: {
                first: false,
                second: false,
                third: false
            },
            currentBatter: 1,
            opponentBatter: 1,
            opponentPlayerCount: 10,
            homeTeamName: "主隊",
            awayTeamName: "客隊",
            playerCount: 10,
            homeBattingOrder: Array(11).fill().map(() => ({
                number: "",
                name: "",
                position: "",
                battingSide: "右打",
                atBats: 0,
                hits: 0,
                homeRuns: 0,
                rbis: 0,
                inningResults: Array(7).fill("")
            })),
            awayBattingOrder: Array(11).fill().map(() => ({
                name: "",
                position: "",
                battingSide: "右打",
                atBats: 0,
                hits: 0,
                rbis: 0
            }))
        };

        function createPositionSelect() {
            let select = document.createElement('select');
            select.innerHTML = '<option value="">選擇位置</option>' +
                POSITIONS.map(pos => `<option value="${pos}">${pos}</option>`).join('');
            return select;
        }

        function updatePlayerCount(count) {
            gameState.playerCount = parseInt(count);
            initializeBattingOrder();
        }

        function updateOpponentBatter(change) {
            gameState.opponentBatter = ((gameState.opponentBatter + change - 1 + gameState.opponentPlayerCount) % gameState.opponentPlayerCount) + 1;
            document.getElementById('opponent-batter-number').textContent = gameState.opponentBatter;
        }

        function updateOpponentPlayerCount(count) {
            gameState.opponentPlayerCount = parseInt(count);
            if (gameState.opponentBatter > gameState.opponentPlayerCount) {
                gameState.opponentBatter = 1;
                document.getElementById('opponent-batter-number').textContent = '1';
            }
        }

        function initializeBattingOrder() {
            const battingOrderList = document.getElementById('batting-order-list');
            battingOrderList.innerHTML = '';
            
            const currentOrder = gameState.homeBattingOrder;
            
            for (let i = 0; i < gameState.playerCount; i++) {
                const row = document.createElement('div');
                row.className = `batter-row ${i + 1 === gameState.currentBatter ? 'current' : ''}`;
                row.draggable = true;
                row.dataset.index = i;
                
                row.innerHTML = `
                    <div class="batter-number">${i + 1}</div>
                    <input type="text" class="batter-number-input" 
                           value="${currentOrder[i].number}"
                           onchange="updateBatterInfo(${i}, 'number', this.value)"
                           placeholder="背號">
                    <input type="text" class="batter-name" 
                           value="${currentOrder[i].name}"
                           onchange="updateBatterInfo(${i}, 'name', this.value)"
                           placeholder="${i + 1}號打者">
                    <select onchange="updateBatterInfo(${i}, 'position', this.value)">
                        <option value="">選擇位置</option>
                        ${POSITIONS.map(pos => 
                            `<option value="${pos}" ${currentOrder[i].position === pos ? 'selected' : ''}>${pos}</option>`
                        ).join('')}
                    </select>
                    <div>${i + 1 === gameState.currentBatter ? '打擊中' : ''}</div>
                `;

                // 添加拖放事件監聽器
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                
                battingOrderList.appendChild(row);
            }
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            // 儲存拖曳的資料
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.batter-row').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this === draggedElement) return;

            const fromIndex = parseInt(draggedElement.dataset.index);
            const toIndex = parseInt(this.dataset.index);

            // 更新打序資料
            const temp = {...gameState.homeBattingOrder[fromIndex]};
            
            if (fromIndex < toIndex) {
                // 向下移動
                for (let i = fromIndex; i < toIndex; i++) {
                    gameState.homeBattingOrder[i] = {...gameState.homeBattingOrder[i + 1]};
                }
            } else {
                // 向上移動
                for (let i = fromIndex; i > toIndex; i--) {
                    gameState.homeBattingOrder[i] = {...gameState.homeBattingOrder[i - 1]};
                }
            }
            gameState.homeBattingOrder[toIndex] = temp;

            // 如果當前打者在移動範圍內，更新當前打者號碼
            if (gameState.currentBatter - 1 === fromIndex) {
                gameState.currentBatter = toIndex + 1;
            } else if (
                (gameState.currentBatter - 1 >= Math.min(fromIndex, toIndex)) && 
                (gameState.currentBatter - 1 <= Math.max(fromIndex, toIndex))
            ) {
                if (fromIndex < toIndex) {
                    gameState.currentBatter--;
                } else {
                    gameState.currentBatter++;
                }
            }

            // 重新渲染打序表
            initializeBattingOrder();
        }

        function updateBatterInfo(index, field, value) {
            gameState.homeBattingOrder[index][field] = value;
        }

        function updateTeamName(team) {
            const newName = document.getElementById(team + '-team-name').value;
            if (team === 'home') {
                gameState.homeTeamName = newName;
            } else {
                gameState.awayTeamName = newName;
            }
        }

        function updateScore(team, change) {
            const scoreElement = document.getElementById(team + '-score');
            const currentScore = parseInt(scoreElement.textContent);
            const newScore = Math.max(0, currentScore + change);
            scoreElement.textContent = newScore;
            if (team === 'home') {
                gameState.homeScore = newScore;
            } else {
                gameState.awayScore = newScore;
            }
        }

        function addOut() {
            if (gameState.outs < 3) {
                gameState.outs++;
                updateOutsDisplay();
                if (gameState.outs === 3) {
                    setTimeout(() => {
                        if (confirm('已三出局，是否要切換局數？')) {
                            changeInning();
                        }
                    }, 100);
                }
            }
        }

        function resetOuts() {
            gameState.outs = 0;
            updateOutsDisplay();
        }

        function updateOutsDisplay() {
            for (let i = 1; i <= 3; i++) {
                const outCircle = document.getElementById('out' + i);
                outCircle.className = 'out-circle' + (i <= gameState.outs ? ' active' : '');
            }
        }

        function toggleBase(base) {
            gameState.bases[base] = !gameState.bases[base];
            document.getElementById(base).className = 
                'base-status' + (gameState.bases[base] ? ' occupied' : '');
        }

        function changeInning() {
            gameState.isTop = !gameState.isTop;
            if (gameState.isTop) {
                gameState.inning++;
            }
            document.getElementById('inning').textContent = gameState.inning;
            document.getElementById('top-bottom').textContent = gameState.isTop ? '上' : '下';
            resetOuts();
            gameState.currentBatter = 1;
            initializeBattingOrder();
        }

        function recordBatterResult() {
            const currentBatterInfo = gameState.homeBattingOrder[gameState.currentBatter - 1];
            const batterName = currentBatterInfo.name || `${gameState.currentBatter}號打者`;
            const batterNumber = currentBatterInfo.number ? `#${currentBatterInfo.number} ` : '';
            const batterResult = document.getElementById('batter-result').value;
            const rbis = parseInt(document.getElementById('rbi-input').value) || 0;

            // 更新打擊統計
            if (!['四壞保送', '故意四壞'].includes(batterResult)) {
                currentBatterInfo.atBats++;
            }
            if (['一安', '二安', '三安', '全壘打'].includes(batterResult)) {
                currentBatterInfo.hits++;
                if (batterResult === '全壘打') {
                    currentBatterInfo.homeRuns++;
                }
            }
            currentBatterInfo.rbis += rbis;

            // 記錄當局打擊結果
            const currentInning = gameState.inning - 1;
            if (currentInning < 7) {
                currentBatterInfo.inningResults[currentInning] = batterResult;
            }

            // 更新打擊歷史記錄
            const history = document.getElementById('batting-history');
            const record = document.createElement('div');
            record.className = 'history-entry';
            const inningText = `${gameState.inning}局${gameState.isTop ? '上' : '下'}`;
            const battingStats = `${currentBatterInfo.atBats}之${currentBatterInfo.hits}`;
            const rbiText = rbis > 0 ? ` 打點: ${rbis}` : '';
            record.textContent = `${inningText} - ${gameState.currentBatter}棒 ${batterNumber}${batterName} ${battingStats}: ${batterResult}${rbiText}`;
            history.insertBefore(record, history.firstChild);

            // 更新統計表格
            updateStatsTable();

            // 重置打點輸入
            document.getElementById('rbi-input').value = '0';

            gameState.currentBatter = gameState.currentBatter % gameState.playerCount + 1;
            initializeBattingOrder();
        }

        function updateStatsTable() {
            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = '';

            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                const row = document.createElement('tr');
                
                // 選手名稱（包含背號）
                const playerName = player.number ? 
                    `#${player.number} ${player.name || `${i + 1}號打者`}` : 
                    (player.name || `${i + 1}號打者`);
                row.innerHTML = `<td>${playerName}</td>`;
                
                // 各局打擊結果
                for (let j = 0; j < 7; j++) {
                    row.innerHTML += `<td>${player.inningResults[j] || ''}</td>`;
                }
                
                // 打擊統計
                const avg = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000';
                row.innerHTML += `
                    <td>${player.atBats}</td>
                    <td>${player.hits}</td>
                    <td>${player.homeRuns}</td>
                    <td>${player.rbis}</td>
                    <td>${avg}</td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function showGameSummary() {
            let summary = `比賽統計\n`;
            summary += `${gameState.homeTeamName} ${gameState.homeScore} : ${gameState.awayScore} ${gameState.awayTeamName}\n\n`;
            summary += `打擊成績：\n`;
            
            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                if (player.atBats > 0) {
                    const avg = (player.hits / player.atBats).toFixed(3);
                    const playerName = player.name || `${i + 1}號打者`;
                    summary += `${playerName}: ${player.atBats}打數 ${player.hits}安打 打點: ${player.rbis} 打擊率${avg}\n`;
                }
            }

            alert(summary);
        }

        function updateCount(type, change) {
            const maxCount = type === 'strike' ? 3 : 4;
            if (type === 'strike') {
                gameState.strikes = Math.max(1, Math.min(maxCount, gameState.strikes + change));
                updateCountDisplay('strike', gameState.strikes);
                if (gameState.strikes === 3) {
                    setTimeout(() => {
                        if (confirm('三振出局，是否要記錄？')) {
                            document.getElementById('batter-result').value = '三振';
                            recordBatterResult();
                            addOut();
                            resetCount();
                        }
                    }, 100);
                }
            } else {
                gameState.balls = Math.max(1, Math.min(maxCount, gameState.balls + change));
                updateCountDisplay('ball', gameState.balls);
                if (gameState.balls === 4) {
                    setTimeout(() => {
                        if (confirm('四壞保送，是否要記錄？')) {
                            document.getElementById('batter-result').value = '四壞保送';
                            recordBatterResult();
                            resetCount();
                        }
                    }, 100);
                }
            }
        }

        function updateCountDisplay(type, count) {
            const maxCount = type === 'strike' ? 3 : 4;
            for (let i = 1; i <= maxCount; i++) {
                const circle = document.getElementById(`${type}${i}`);
                circle.className = 'count-circle' + (i <= count ? ' active' : '');
            }
        }

        function resetCount() {
            gameState.strikes = 1;
            gameState.balls = 1;
            updateCountDisplay('strike', 1);
            updateCountDisplay('ball', 1);
        }

        // 初始化頁面
        function initializeGame() {
            initializeBattingOrder();
            updateCountDisplay('strike', 1);
            updateCountDisplay('ball', 1);
            updateStatsTable();
        }

        // 修改初始化調用
        window.onload = function() {
            initializeGame();
        };

        function exportToCSV() {
            let csvContent = '\uFEFF';  // BOM for Excel UTF-8
            
            // 比賽基本資訊和第一個表格
            csvContent += `比賽結果：${gameState.homeTeamName} ${gameState.homeScore} : ${gameState.awayScore} ${gameState.awayTeamName}\n\n`;
            csvContent += '選手,打席,安打,打點,打擊率\n';
            
            // 第一個表格資料（簡易統計）
            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                if (player.atBats > 0) {
                    const avg = (player.hits / player.atBats).toFixed(3);
                    const playerName = player.name || `${i + 1}號打者`;
                    csvContent += `${playerName},${player.atBats},${player.hits},${player.rbis},${avg}\n`;
                }
            }

            // 空一行後加入詳細打擊表格
            csvContent += '\n詳細打擊紀錄\n';
            csvContent += '背號,選手,第1局,第2局,第3局,第4局,第5局,第6局,第7局,打數,安打,全壘打,打點,打擊率\n';

            // 詳細打擊統計資料
            for (let i = 0; i < gameState.playerCount; i++) {
                const player = gameState.homeBattingOrder[i];
                const avg = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000';
                const playerName = player.name || `${i + 1}號打者`;
                
                let row = [
                    player.number,
                    playerName,
                    ...player.inningResults.slice(0, 7).map(result => result || ''),
                    player.atBats,
                    player.hits,
                    player.homeRuns,
                    player.rbis,
                    avg
                ];
                
                csvContent += row.map(field => {
                    if (field && field.toString().includes(',')) {
                        return `"${field}"`;
                    }
                    return field;
                }).join(',') + '\n';
            }

            // 建立檔案名稱，只包含年月日
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const filename = `比賽統計_${year}${month}${day}_${gameState.homeTeamName} vs ${gameState.awayTeamName}.csv`;

            // 建立並觸發下載
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(link.href);
        }
    </script>
</body>
</html> 